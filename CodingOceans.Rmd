---
title: "Marine Protected Area Activity"
output: html_notebook
---

The U.S. has established nearly 1,000 Marine Protected Areas to protect important places in our ocean, estuaries, coastal waters, and Great Lakes. Marine Protected Areas strive to combat climate change, conserve cultural heritage, and protect marine organisms. 

Marine protected areas allow for ecological connectivity, and serve as protected "stepping stones" for marine organisms. Let's make a map so that we can see all of these stepping stones off of the Coast of California.

First, we'll need to load in some data that has information on all of the Marine Protected Areas in the United States. The data is in the form of a "shape file". We will load this file and call it "DataBase". 

```{r}
#install and load the "sf" package to read in the databse
install.packages("sf")
library("sf")

# loading our database by setting the directory where the shape file lives with the file extension (.shp)
DataBase = st_read("C:/Users/nposd/Documents/Outreach/MPAs/mpa_inventory_2014_public_shp.shp")

```

For this example, let's look at the Marine Protected areas off the Coast of California. When looking at our database, we see that there is a column titled "State", and each row contains the state that the Marine Protected Area is in. We will filter our database to pull out all of the Marine Protected Areas that are in the "State" of "California" using the following code chunk. We will call this new database "California". 

```{r}
# install and load the "dplyr" package to help us filter our data
library(dplyr)

California = filter(DataBase, State == "California")

```

There are 185 Marine Protected Areas in our California database! Let's make a map to see all of the boundaries of the Marine Protected Areas. The "geometry" column has the information of the boundaries. The geometry will give us the latitude and longitude, which we will use to plot the boundary of each Marine Protected Area on our map. 

To set up the map, we will first map a blank map of the state of California. We will use built-in "leaflet" library to make our map. Let's set it up so that we can see the ocean topography using the Esri Ocean Basemap. We'll save our map as "CaliforniaMap". To print the CaliforniaMap, we'll type in CaliforniaMap. 


```{r}
# install and load the leaflet package so that we can make our map
library(leaflet)

CaliforniaMap = leaflet() %>% # start an empty map
   addProviderTiles("Esri.OceanBasemap") %>% # add the ocean basemap 
   fitBounds( -124, 41, -116, 32) # zoom in to the california area

CaliforniaMap # print the map

```
Nice! Now let's add the boundaries of all of the Marine Protected Areas that are on the California Coast. We will loop through each individual Marine Protected area, and plot the latitudes and longitudes on our California map, that way, we can see ALL of the Marine Protected Areas on our map together. We will use "addPolygons" to add each Marine Protected Area's boundary. You can pick the color that you would like to make the boundary in the "color" section of "addPolygons". For this example, I made the color red, but you can change it to whatever color you would like!

```{r}

# loop through each MPA and plot the boundaries on our California Map
for(i in 1:length(California$Site_Name)) {
Geo = as.data.frame(California[[25]][[i]][[1]][[1]]) #the geometry is in the 25th column
Longitude = Geo$V1 #Longitude is saved as Variable 1
Latitude = Geo$V2 #Latitude is saved as Variable 2
CaliforniaMap = CaliforniaMap  %>% 
       addPolygons(lng=Longitude,lat=Latitude, 
                   color = "red", # I wanted to make the MPAs red, but you can put any colors you want!
                   opacity = .5, 
                   fillOpacity = 0.2)
}

CaliforniaMap # print the map
```
```

```
Wow, California has a LOT of Marine Protected Areas! Let's analyze some data from Marine Protected Areas in California to see exactly how they have helped in the protection of marine organisms! We will need to connect to an online databases to access information about marine organisms. Additionally, some packages in R will need to be installed so that we can see exactly what is going in with our data. Run the code chunk below to install the packages necessary for this activity. 

```{r}
#load libraries
install.packages("robis")
library(robis)
library('ggplot2')
install.packages("rnaturalearth")
library("rnaturalearth")
install.packages("rnaturalearthdata")
library("rnaturalearthdata")
library(roperators)
install.packages("roperators")

library(magrittr) 
install.packages("vegan")
library(vegan)

install.packages("measurements")
library(measurements)

installed <- rownames(installed.packages())
if ( !("robis" %in% installed) ){
   if ( !("remotes" %in% installed) )install.packages("remotes")
   remotes::install_github("iobis/robis")
}
library("robis")

install.packages("wellknown")
install.packages("V8")
library("V8")
library("wellknown")

```
```


```
Let's choose a specific Marine Protected Area we want to learn more about. 
```{r}
SiteName = ('Scripps Coastal Reserve') #Look at the California data frame in your global environment...
# and choose the MPA you want to learn more about
ChosenMPA = filter(California, Site_Name == SiteName) #filter for that specific MPA
#get the MPA polygon ready
ChosenMPA_hull = st_convex_hull(ChosenMPA$geometry)
ChosenMPA_text = st_as_text(ChosenMPA_hull)
```
Introduce OBIS
```{r}
SpeciesOccurence = occurrence(geometry = ChosenMPA_text)
```
```{r}
# Let's sum up the unique species that occur in the chosen MPA
if ("individualCount" %in% colnames(SpeciesOccurence)){ #if individualCount is an available column..
  SpeciesOccurence$individualCount <- suppressWarnings(as.numeric(SpeciesOccurence$individualCount)) #introduces NAs
  SpeciesOccurence$individualCount[is.na(SpeciesOccurence$individualCount)] <- 1 #convert NANs to 1; I'm assuming that if it's listed, there was at least one count
  SpeciesOccurence$Count <- 1 * SpeciesOccurence$individualCount #make a new column for Counts of each species
} else {
  SpeciesOccurence$Count = 1 #if individualCount is not a column, I'm assuming that if it's listed there was at least 1 count
}
```

Now that our data is ready, let's visualize it and see what patterns we can find! 
We'll start with visualizing the different phyla that exist within the MPA. A phylum is a level of classification or taxonmic rank that allows scientists to categrozie animals. Mammals are in the chordate phylum while insects, spiders, millipeds, and crustaceans are in the arthropod phylum. Let's look to see what phyla exist in this MPA.

```{r}
Phylum <- aggregate(SpeciesOccurence$Count, by=list(Category=SpeciesOccurence$phylum),FUN=sum) #aggregate the data by phyla

#Create a pie chart to visualize the proportion of phyla found in the MPA
bp<- ggplot(Phylum, aes(x="", y=x, fill=Category))+
  geom_bar(width = 1, stat = "identity")
pie = bp + coord_polar("y", start=0)
pie + scale_fill_brewer("Blues") +
  theme(axis.text.x = element_blank())
```


```{r}

animals = filter(SpeciesOccurence, kingdom == "Animalia") #filtering the dataframe to pull out the animals
TenAnimals = data.frame(sort(table(animals$scientificName), decreasing = TRUE)[1:10]) #finding the 10 animals that occur most often in the dataframe
print(TenAnimals)
MostCommon_Animal = filter(SpeciesOccurence, scientificName == TenAnimals$Var1[[1]]) #since kelpbass is the most commonly occuring animal, pull out info on the kelp bass

ggplot(MostCommon_Animal, aes(x = date_year)) + 
  geom_histogram(color = "darkblue", fill = "lightblue") + 
  labs(title = "Kelp Bass in Anacapa State Marine Reserve", x = "Year", y = "# of Kelp Bass") # make a histogram showing the kelp bass count from 2006 through 2020


```


